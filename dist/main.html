<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <script src="js/leaflet-heat.js"></script>
    <script src="https://unpkg.com/d3@5.14.2/dist/d3.js"></script>
    <style>
        #map {
            height: 500px;
        }
    </style>
</head>

<body>
    <div id="map">

    </div>
    <script>
        var map = L.map('map').setView([40.439722, -79.976389], 11);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            accessToken: 'pk.eyJ1IjoicmZ1bG9wIiwiYSI6ImNrNDF5ZjR3djA2aDkza28wZzI2bmM4NnkifQ.YiEEMa_YYxIVKHSn6xXUVg'
        }).addTo(map);
        d3.dsv("|","data/bus_stop_usage_filtered.csv", function (stop) {
            let ridership = +stop['FY19_AVG_TOTAL'];
            if (stop == NaN) {
                ridership = 0.0;
            }
            return [+stop['LATITUDE'], +stop['LONGITUDE'], ridership];
        }).then(function (stop_usage) {
            var max_usage = stop_usage.map(el => el[2])
                .reduce((a, b) => Math.max(a, b), -Infinity);
            var usage = stop_usage.filter(function (s) {
                return s[0] != null && s[1] != null && s[2] != null && s[0] != NaN && s[1] != NaN;
            }).map(function scaleIntensity(s) {
                return [s[0], s[1], s[2] / max_usage];
            });
            console.log(usage)
            var heat = L.heatLayer(usage, { radius: 25 }).addTo(map);
        });
    </script>
</body>

</html>